<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">

<title>리서치 입력 프로그램</title>

<style>
body {
    padding: 5px;
    margin: 0;
}

label {
    font-size: 14px;
}

table {
    border-collapse: collapse;
}

th, td {
    padding: 5px;
    border: 1px solid #ccc;
}

th {
    background-color: #f2f2f2;    
}

th:first-child, td:first-child {
    width: 65px;
    text-align: center;
}

input[type="file"] {
    padding: 1px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.overflow {
    overflow-x : auto;
}

.no-wrap {
    white-space: nowrap;
}

.button {
    display: inline-block;
    padding: 5px;
    background-color: #007bff;
    color: #fff;
    text-decoration: none;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

/* 호버(마우스 올릴 때) 스타일 */
.button:hover {
    background-color: #0056b3;
}

.tbl-input {
    margin-bottom: 5px;
}

.tbl-result tr:hover {
    background-color: #f2f2f2;
}

.tbl-result th {
    position: sticky;
    top: 241px;
    z-index: 1;
}

.input-box {
    width: 40px;
}

.top-fixed {
    position: fixed;
    top: 0;
    width: 100%;
    background-color: #f2f2f2;
    padding: 10px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.top-fixed div {
    padding: 3px 0 0 0;
}

.content {
    padding-top: 240px; /* 상단 고정 요소의 높이만큼 여백 추가 */
}

.floating-box {
    background-color: #f8e5db;
    position: fixed;
    bottom: 50px;
    right: 5px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s;
    opacity: 0.9;
}

.rule-invalid {
    background-color: #fdc7c3;
}

.input-form-box {
    width: 250px;
}

.illegal {
    width: 302px;    
    color: black;
    border: 2px solid rgb(255, 159, 159);
}

.hidden {
    display: none;
}
</style>


<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha256-tG5mcZUtJsZvyKAxYLVXrmjKBVLd6VpVccqz/r4ypFE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>


<script>
//----------------------- 입력 규칙 -----------------------//
const ri_rule = {
    caution: "<h3>주의사항</h3>입력 주의사항이나 코드표 관련<br>남자는 1로 입력, 여자는 2로 입력",
    cols: [
        {name: "id"},
        {name: "1"},
        {name: "2"},
        {name: "3", rule: [{value: "3", test: "=", to: "5", empty: "4"}, {value: "3", test: "!", to: "4", empty: "5"}]},
        {name: "3-1", rule: [{value: "3", test: "=", to: "5"}, {value: "3", test: "!", empty: "3-2"}]},
        {name: "3-2"},
        {name: "4", rule: [{value: "30", test: ">=", to: "8", empty: "7"}, {value: "30", test: "<", to: "7", empty: "8"}]},
        {name: "5"},
        {name: "6"},
        {name: "7"},
        {name: "8"},
        {name: "9"},
        {name: "9-1"},
        {name: "9-2"},
        {name: "9-3"},
        {name: "10"},
        {name: "11"},
        {name: "12"}
    ]
};
//----------------------- 입력 규칙 -----------------------//

const ri_main = {
    s2ab(s) { 
        // ref : https://redstapler.co/sheetjs-tutorial-create-xlsx/
        const buf = new ArrayBuffer(s.length);
        let view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) {
            view[i] = s.charCodeAt(i) & 0xFF;
        }
        return buf;    
    },

    fixedForm : function() {
        const divHeight = $(".top-fixed").height() + 21;
        $(".content").css({
            "padding-top" : divHeight + "px"
        });

        $(".tbl-result th").css({
            "top" : divHeight + "px"
        });
    },

    initFormTableHead : function() {
        // 입력 폼 테이블 thead 설정
        const newRow = $("<tr>");
        ri_rule.cols.forEach(e => {
            newRow.append($("<th>").text(e.name));
        });
        $(".tbl-input thead").append(newRow);
    },

    initFormTableBody : function() {
        // 입력 폼 테이블 tbody 설정
        const newRow = $("<tr>");
        ri_rule.cols.forEach(e => {
            newRow.append($("<td>").append($("<input>", {type: "number", class: "input-box"})));
        });
        $(".tbl-input tbody").append(newRow);
    },

    initResultTable : function() {
        // 입력 결과 테이블 설정
        const newRow = $("<tr>");
        newRow.append($("<th>").text("구분"));
        newRow.append($("<th>").text("검증"));
        ri_rule.cols.forEach(e => {
            newRow.append($("<th>").text(e.name));
        });
        $(".tbl-result thead").append(newRow);
    },

    initBox : function() {
        // 주의 상자 설정
        if (ri_rule.caution && ri_rule.caution.length > 0) {
            $("#caution").append(ri_rule.caution).removeClass("hidden");
        }
    },

    clearForm : function() {
        $(".tbl-input tr input, .input-form-box").val("");
    },

    invalidRule : function(data) {
        // TODO: 룰 검증
    },

    inputTable : function(data, upload) {
        // 첫번째는 삭제 버튼
        const newRow = $("<tr>");                
        newRow.append($("<td>").append($("<a>").addClass("delete-link").addClass("button").attr("href", "#").text("삭제")));

        const msg = ri_main.invalidRule(data);
        if (msg) {
            // 업로드가 아니면 한줄 추가이므로 메시지 처리
            if (!upload) {
                $("#illegal").val(msg);
            }
            newRow.addClass("rule-invalid");
            newRow.append($("<td>").append("FALSE"));            
        } else {
            newRow.append($("<td>").append("TRUE"));
        }        

        for(let i = 0; i < ri_rule.cols.length; i++) {
            if (i < data.length) {
                if (typeof data[i] === "string") {
                    data[i] = data[i].trim()
                }
                newRow.append($("<td>").text(data[i]));
            } else {
                newRow.append($("<td>"));
            }
        }

        const lastRow = $(".tbl-result tbody tr:last");
        if (lastRow.length) {
            lastRow.after(newRow);
        } else {
            // 테이블에 행이 없는 경우, tbody 내부에 직접 추가합니다.
            $(".tbl-result tbody").append(newRow);
        }

        // 현재 행 삭제 이벤트 추가
        $(".delete-link").on("click", function(e) {        
            e.preventDefault();
            $(this).closest("tr").remove();
        });
    },

    scrollToEnd : function() {
        // 입력한 결과 확인을 위해 끝으로
        const windowHeight = $(window).height();
        const scrollHeight = $("body").height() - windowHeight;
        window.scrollTo({
            top: scrollHeight,
            behavior: "smooth"
        });
    },

    triggerInputTable : function(values, upload) {
        if (!values || values.length == 0) {
            return;
        }

        ri_main.inputTable(values, upload);

        if ($("#autoInit").prop("checked")) {
            ri_main.clearForm();
        }

        if (!upload) {
            ri_main.scrollToEnd();
        }        
    },

    isEmptyValue : function(values) {
        if (!values) {
            return false;
        }

        if (values.length == 0) {
            return false;
        }

        for (let i = 0; i < values.length; i++) {
            if (values[i].length > 0) {
                return true;
            }
        }

        return false;
    },

    getTableData : function() {
        const theadData = [];
        $("#sheet1 thead th").each(function() {
            const data = String($(this).text());
            if ("구분" !== data) {
                theadData.push(data);
            }
        });

        const tbodyData = [];
        $("#sheet1 tbody tr").each(function() {
            const rowData = [];
            $(this).find("td").each(function() {
                const data = String($(this).text());
                if ("삭제" !== data) {
                    rowData.push(data);
                }
            });
            tbodyData.push(rowData);
        });

        tbodyData.unshift(theadData)
        return tbodyData;
    },

    getSeparatorValues : function() {
        const value = $("#result").val();
        if (value.length == 0) {
            return [];
        }

        const separator = $("#separator").val();            
        return value.split(separator);
    },

    getEditorValues : function() {
        const values = [];
        $(".tbl-input tbody tr").each(function() {
            const rowInputs = $(this).find("input");
            const rowData = rowInputs.map(function() {
                return String($(this).val()).trim();
            }).get();

            if (!ri_main.isEmptyValue(rowData)) {
                return;
            }
            
            values.push(rowData);
        });

        if (values.length == 1) {
            return values[0];
        }
        return [];
    },

    eventHandler : {
        onClickInput : function() {           
            const values = ri_main.getSeparatorValues();
            if (!ri_main.isEmptyValue(values)) {
                return;
            }

            ri_main.triggerInputTable(values);            
        },

        onClickDownload : function() {
            const tableData = ri_main.getTableData();
            if (tableData.length < 1) {
                alert("저장할 내용이 없습니다.");
                return;
            }

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(tableData);

            for (let key in worksheet) {
                if (worksheet.hasOwnProperty(key) && worksheet[key].t === "n") {
                    worksheet[key].t = "s";
                    worksheet[key].v = String(worksheet[key].v);
                }
            }

            XLSX.utils.book_append_sheet(workbook, worksheet, "sheet1");
            const workbookFile = XLSX.write(workbook, {bookType:'xlsx',  type: 'binary'});
            saveAs(new Blob([ri_main.s2ab(workbookFile)],{type:"application/octet-stream"}), "research_result.xlsx");
        },

        onClickUpload : function() {
            // 테이블 초기화 후 진행되므로 경고
            if (!confirm("현재까지 입력된 내용이 초기화 됩니다.\n계속 하시겠습니까?")) {
                return;
            }

            const fileInput = document.getElementById('excelUpload');
            const file = fileInput.files[0];

            if (!file) {
                return;
            }

            $(".tbl-result tbody").empty();

            const reader = new FileReader();
            reader.onload = function (event) {
                const data = event.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                
                sheetData.forEach(function(row){
                    const values = [];
                    ri_rule.cols.forEach(e => {
                        // 해당 값이 있는지 체크 후 처리
                        if (row.hasOwnProperty(e.name)) {
                            values.push(row[e.name]);
                        } else {
                            values.push("");
                        }                                
                    });
                    ri_main.triggerInputTable(values, true);
                });
            };
            reader.readAsBinaryString(file);
        },

        onClickFormInput : function() {
            const values = ri_main.getEditorValues();
            ri_main.triggerInputTable(values);
        },

        onClickFormInit : function() {
            if (!confirm("입력된 내용을 모두 초기화 하시겠습니까?")) {
                return;
            }
            ri_main.clearForm();
        }
    }
};
</script>

</head>
<body>
    <div class="top-fixed no-wrap">
        <div>
            <a href="javascript:ri_main.eventHandler.onClickDownload();" class="button">다운로드</a>
            <input type="file" id="excelUpload" accept=".xlsx">
            <a href="javascript:ri_main.eventHandler.onClickUpload();" class="button">업로드</a>
        </div>        
        <div>
            <label for="separator">구분자:</label>
            <select id="separator">
                <option value=" " selected>(공백)</option>
                <option value=",">,</option>
                <option value="/">/</option>
            </select>
            <input type="text" id="result" class="input-form-box">&nbsp;<a href="javascript:ri_main.eventHandler.onClickInput();" class="button">입력</a><br>
            <label>검증결과: <input type="text" id="illegal" class="input-form-box illegal" disabled></label>
        </div>
        <div class="overflow">
            <table class="tbl-input">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <div>            
            <a href="javascript:ri_main.eventHandler.onClickFormInput();" class="button">입력</a>&nbsp;&nbsp;
            <a href="javascript:ri_main.eventHandler.onClickFormInit();" class="button">초기화</a>&nbsp;&nbsp;
            <label><input type="checkbox" id="autoInit">입력 후 자동 초기화</label>
        </div>
    </div>    
    <div class="content no-wrap">
        <!-- 입력 결과 출력 (삭제 기능) -->
        <table id="sheet1" class="tbl-result">
            <thead></thead>
            <tbody></tbody>        
        </table>
    </div>
    
    <div id="caution" class="floating-box hidden"></div>    
<script>
$(document).ready(function(){
    if ($.isEmptyObject(ri_rule)) {
        alert("입력 규칙 설정 후 사용 가능합니다.");
        $("#result, #put, #excel").attr("disabled", true);
        return;
    }    

    ri_main.initFormTableHead();
    ri_main.initFormTableBody();
    ri_main.initResultTable();
    ri_main.initBox();

    ri_main.fixedForm();
});

$(window).resize(function() {
    ri_main.fixedForm();
});
</script>
</body>
</html>