<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">

<title>리서치 입력 프로그램</title>

<style>
body {
    padding: 5px;
    margin: 0;
}

label {
    font-size: 14px;
}

table {
    border-collapse: collapse;
}

th, td {
    padding: 5px;
    border: 1px solid #ccc;
}

th {
    background-color: #f2f2f2;    
}

th:first-child, td:first-child {
    width: 65px;
    text-align: center;
}

input[type="file"] {
    padding: 1px;
    border: 1px solid #ccc;
    border-radius: 5px;
}

.overflow {
    overflow-x : auto;
}

.no-wrap {
    white-space: nowrap;
}

.button {
    display: inline-block;
    padding: 5px;
    background-color: #007bff;
    color: #fff;
    text-decoration: none;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
}

.button:hover {
    background-color: #0056b3;
}

.tbl-input {
    margin-top: 10px;
    margin-bottom: 5px;
}

.tbl-result tr:hover {
    background-color: #f2f2f2;
}

.tbl-result th {
    position: sticky;
    top: 241px;
    z-index: 1;
}

.tbl-head-message {
    font-size: 12px;
    font-weight: lighter;
    background-color: #fcf9d2;
}

.tbl-head-message p {
    margin: 0;
}

.tbl-input tbody td {
    background-color: #fdfdfd;
}

.tbl-illegal-col {
    border: 2px solid #ff6060;
    background-color: #fcc0c0;
}

.input-box {
    width: 60px;
}

.top-fixed {
    position: fixed;
    top: 0;
    width: 100%;
    background-color: #f2f2f2;
    padding: 10px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.top-fixed div {
    padding: 3px 0 0 0;
}

.content {
    padding-top: 240px; /* 상단 고정 요소의 높이만큼 여백 추가 */
}

.floating-box {
    background-color: #f8e5db;
    position: fixed;
    bottom: 50px;
    right: 5px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s;
    opacity: 0.9;
}

.rule-invalid {
    background-color: #fdc7c3;
}

.input-form-box {
    width: 250px;
}

.illegal {
    width: 302px;    
    color: black;
    border: 2px solid rgb(255, 159, 159);
    background-color: #ffffff;
}

.hidden {
    display: none;
}
</style>


<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>


<script>
//----------------------- 입력 규칙 -----------------------//
const ri_rule = {
    caution: "<h3>주의사항</h3>ex)<br>1이상 : 1을 포함한 큰 수<br>1이하 : 1을 포함한 작은 수<br>1초과 : 1을 제외한 큰 수<br>1미만 : 1을 제외한 작은 수<br><br>ex) 남자는 1로 입력, 여자는 2로 입력",
    cols: [
        {name: "id"},
        {name: "1"},
        {name: "2"},
        {name: "3", rules: [{value: "3", test: "=", to: "5", empty: "4"}, {value: "3", test: "!", to: "4", empty: "5"}]},
        {name: "3-1", rules: [{value: "3", test: "=", to: "6"}, {value: "3", test: "!", empty: "3-2"}]},
        {name: "3-2"},
        {name: "4", rules: [{value: "30", test: ">=", to: "8", empty: "7"}, {value: "30", test: "<", to: "7", empty: "8"}]},
        {name: "5"},
        {name: "6"},
        {name: "7"},
        {name: "8"},
        {name: "9", rules: [{value: "2", test: "!", empty: "11"}]},
        {name: "9-1"},
        {name: "9-2"},
        {name: "9-3"},
        {name: "10"},
        {name: "11"},
        {name: "12"}
    ]
};
//----------------------- 입력 규칙 -----------------------//

const ri_main = {
    s2ab(s) { 
        // ref : https://redstapler.co/sheetjs-tutorial-create-xlsx/
        const buf = new ArrayBuffer(s.length);
        let view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) {
            view[i] = s.charCodeAt(i) & 0xFF;
        }
        return buf;    
    },

    fixedForm : () => {
        const divHeight = $(".top-fixed").height() + 21;
        $(".content").css({
            "padding-top" : divHeight + "px"
        });

        $(".tbl-result th").css({
            "top" : divHeight + "px"
        });
    },

    makeRuleMessages : (rules) => {
        if (!rules) {
            return [];
        }

        const msgs = [];
        for (let i = 0; i < rules.length; i++) {
            let msg = String(rules[i].value);

            switch (rules[i].test) {
                case "=":
                    msg += " 이면";
                    break;
                case "!":
                    msg += " 아니면";
                    break;
                case ">":
                    msg += " 초과";
                    break;
                case "<":
                    msg += " 미만";
                    break;
                case ">=":
                    msg += " 이상";
                    break;
                case "<=":
                    msg += " 이하";
                    break;
            }

            if (rules[i].to) {
                msg += " " + rules[i].to + "번 필수";
            }

            if (rules[i].empty) {
                if (rules[i].to) {
                    msg += ","
                }
                msg += " " + rules[i].empty + "번 입력X";
            }
            msgs.push(msg);
        }
        return msgs;
    },

    initFormTableHead : () => {
        // 입력 폼 테이블 thead 설정
        const newRow = $("<tr>");
        const newMsg = $("<tr>");
        ri_rule.cols.forEach(e => {
            newRow.append($("<th>").append(e.name));

            const headMsg = $("<th>").addClass("tbl-head-message");            
            if (e.rules) {
                let msgs = ri_main.makeRuleMessages(e.rules);
                for (let i = 0; i < msgs.length; i++) {
                    headMsg.append($("<p>").append(msgs[i]));
                }
            }
            newMsg.append(headMsg);
        });
        $(".tbl-input thead").append(newRow).append(newMsg);
    },

    initFormTableBody : () => {
        // 입력 폼 테이블 tbody 설정
        const newRow = $("<tr>");
        ri_rule.cols.forEach(e => {
            newRow.append($("<td>").append($("<input>", {type: "number", class: "input-box", min: 0, step: 1})));
        });
        $(".tbl-input tbody").append(newRow);
    },

    initResultTable : () => {
        // 입력 결과 테이블 설정
        const newRow = $("<tr>");
        newRow.append($("<th>").text("구분"));
        newRow.append($("<th>").text("검증"));
        ri_rule.cols.forEach(e => {
            newRow.append($("<th>").text(e.name));
        });
        $(".tbl-result thead").append(newRow);
    },

    initCautionBox : () => {
        // 주의 상자 설정
        if (ri_rule.caution && ri_rule.caution.length > 0) {
            $("#caution").append(ri_rule.caution).removeClass("hidden");
        }
    },

    clearForm : () => {
        $(".tbl-input tr input, .input-form-box").val("");
        $(".tbl-input thead tr").each(function() {
            $(this).find("th").removeClass("tbl-illegal-col");
        });
        $(".tbl-input tbody tr").each(function() {
            $(this).find("td").removeClass("tbl-illegal-col");
        });
    },
    
    findRuleIndex : (name) => {
        for (let i = 0; i < ri_rule.cols.length; i++) {
            if (ri_rule.cols[i].name == name) {
                return i;
            }
        }
        ri_rule.cols
        return;
    },

    isPassRuleTest : (value, rule) => {
        switch (rule.test) {
            case "=":
                return parseInt(value) == parseInt(rule.value);
            case "!":
                return parseInt(value) != parseInt(rule.value);
            case ">":
                return parseInt(value) > parseInt(rule.value);
            case "<":
                return parseInt(value) < parseInt(rule.value);
            case ">=":
                return parseInt(value) >= parseInt(rule.value);
            case "<=":
                return parseInt(value) <= parseInt(rule.value);
        }
        return true;
    },

    findIllegalIndex : (values) => {
        // TODO: 룰 검증
        for (let i = 0; i < ri_rule.cols.length; i++) {
            const rules = ri_rule.cols[i].rules;
            if (rules && rules.length > 0) {
                // TODO: 룰 검증...
            }
        }                
        // return 11;
        return -1;
    },

    drawIllegalFormTable : idx => {
        // 틀린 열 표시
        $(".tbl-input thead tr").each(function() {
            $(this).find("th:eq("+ idx +")").addClass("tbl-illegal-col");
        });

        $(".tbl-input tbody tr").each(function() {
            $(this).find("td:eq("+ idx +")").addClass("tbl-illegal-col");
        });

        // 스크롤 처리
        const targetColumn = $(".tbl-input thead th:nth-child(" + (idx + 1) + ")");
        const container = $(".overflow");
        const targetScrollLeft = targetColumn.position().left + container.scrollLeft();

        container.animate({
            scrollLeft: targetScrollLeft
        }, 500);
    },

    appendResultTableRow : (values, options) => {
        // 첫번째는 삭제 버튼
        const newRow = $("<tr>");                
        newRow.append($("<td>").append($("<a>").addClass("delete-link").addClass("button").attr("href", "#").text("삭제")));

        // 룰 검증 처리
        const illegalIdx = ri_main.findIllegalIndex(values);
        if (illegalIdx != -1) {
            // 업로드가 아니면 한줄 추가이므로 메시지 처리
            if (!options || options.type != "upload") {
                let msgs = ri_main.makeRuleMessages(ri_rule.cols[illegalIdx].rules);
                $("#illegal").val(msgs.join(" | "));

                ri_main.drawIllegalFormTable(illegalIdx);
            }
            newRow.append($("<td>").addClass("rule-invalid").append("FALSE"));            
        } else {
            newRow.append($("<td>").append("TRUE"));
        }        

        // 입력 데이터 행 생성
        for (let i = 0; i < ri_rule.cols.length; i++) {
            if (i < values.length) {
                if (typeof values[i] === "string") {
                    values[i] = values[i].trim()
                }
                newRow.append($("<td>").text(values[i]));
            } else {
                newRow.append($("<td>"));
            }
        }

        // 행 클릭 이벤트 추가
        newRow.click(function() {
            // 입력된 내용이 없어야만 진행
            if (!ri_main.isFormEditorEmpty()) {
                return;
            }

            // 클릭된 로우 값 가져오기
            const tableRows = [];
            $(this).find("td").map(function(index) {
                // 삭제, 검증 컬럼 제외
                if (index > 1) {
                    tableRows.push(String($(this).text()).trim());
                }
            });

            $("#separatorBox").val(tableRows.join($("#separator").val()));
            $(".input-box").map(function(index) {
                if (index < tableRows.length) {
                    $(this).val(tableRows[index]);
                }
            });
        });

        // 생성된 행 추가
        const lastRow = $(".tbl-result tbody tr:last");
        if (lastRow.length) {
            lastRow.after(newRow);
        } else {
            // 테이블에 행이 없는 경우, tbody 내부에 직접 추가합니다.
            $(".tbl-result tbody").append(newRow);
        }

        // 현재 행 삭제 이벤트 추가
        $(".delete-link").on("click", function(e) {
            e.preventDefault();
            $(this).closest("tr").remove();
        });
    },

    scrollToEnd : () => {
        // 입력한 결과 확인을 위해 끝으로
        const windowHeight = $(window).height();
        const scrollHeight = $("body").height() - windowHeight;
        window.scrollTo({
            top: scrollHeight,
            behavior: "smooth"
        });
    },

    triggerAppendTableRow : (values, options) => {
        if (!values || values.length == 0) {
            return;
        }

        ri_main.appendResultTableRow(values, options);

        if ($("#autoInit").prop("checked")) {
            ri_main.clearForm();
        }

        if (options && options.type != "upload") {
            ri_main.scrollToEnd();
        }        
    },

    isEmptyValue : values => {
        if (!values) {
            return true;
        }

        if (values.length == 0) {
            return true;
        }

        for (let i = 0; i < values.length; i++) {
            if (values[i].length > 0) {
                return false;
            }
        }

        return true;
    },

    isFormEditorEmpty: () => {
        let separator = $("#separatorBox").val().trim();
        let inputBoxs = ri_main.getFormTableValues().join("");
        return separator.length == 0 && inputBoxs.length == 0;
    },

    getResultTableRows : () => {
        const theadRows = [];
        $("#sheet1 thead th").each(function() {
            const value = String($(this).text());
            if ("구분" !== value) {
                theadRows.push(value);
            }
        });

        const tbodyRows = [];
        $("#sheet1 tbody tr").each(function() {
            const row = [];
            $(this).find("td").each(function() {
                const data = String($(this).text());
                if ("삭제" !== data) {
                    row.push(data);
                }
            });
            tbodyRows.push(row);
        });

        tbodyRows.unshift(theadRows)
        return tbodyRows;
    },

    getSeparatorValues : () => {
        const value = $("#separatorBox").val();
        if (value.length == 0) {
            return [];
        }

        const separator = $("#separator").val();
        return value.split(separator);
    },

    getFormTableValues : () => {
        const values = [];
        $(".input-box").each(function() {
            values.push(String($(this).val()).trim());
        });
        return values;
    },

    getNowDateTimeString : () => {
        const currentDateTime = new Date();
        const year = currentDateTime.getFullYear();
        const month = (currentDateTime.getMonth() + 1).toString().padStart(2, '0');
        const day = currentDateTime.getDate().toString().padStart(2, '0');
        const hours = currentDateTime.getHours().toString().padStart(2, '0');
        const minutes = currentDateTime.getMinutes().toString().padStart(2, '0');
        const str = `${year}${month}${day}_${hours}${minutes}`;
        return str;
    },

    eventHandler : {
        onClickInput : () => {           
            const values = ri_main.getSeparatorValues();
            if (ri_main.isEmptyValue(values)) {
                return;
            }
            ri_main.triggerAppendTableRow(values);
        },

        onClickDownload : () => {
            const tableRows = ri_main.getResultTableRows();
            if (tableRows.length < 1) {
                alert("저장할 내용이 없습니다.");
                return;
            }

            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(tableRows);

            for (let key in worksheet) {
                if (worksheet.hasOwnProperty(key) && worksheet[key].t === "n") {
                    worksheet[key].t = "s";
                    worksheet[key].v = String(worksheet[key].v);
                }
            }

            XLSX.utils.book_append_sheet(workbook, worksheet, "sheet1");
            const workbookFile = XLSX.write(workbook, {bookType:'xlsx',  type: 'binary'});
            saveAs(new Blob([ri_main.s2ab(workbookFile)],{type:"application/octet-stream"}), "research_"+ ri_main.getNowDateTimeString() +".xlsx");
        },

        onClickUpload : () => {
            // 테이블 초기화 후 진행되므로 경고
            if (!confirm("현재까지 입력된 내용이 초기화 됩니다.\n계속 하시겠습니까?")) {
                return;
            }

            const fileInput = document.getElementById('excelUpload');
            const file = fileInput.files[0];

            if (!file) {
                return;
            }

            $(".tbl-result tbody").empty();

            const reader = new FileReader();
            reader.onload = e => {
                const data = e.target.result;
                const workbook = XLSX.read(data, {type: 'binary'});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];

                // 시트 내의 셀 범위 계산 (A1 형식)
                const range = XLSX.utils.decode_range(worksheet['!ref']);                

                // 각 셀을 순회하며 데이터 추출
                for (let row = range.s.r + 1; row <= range.e.r; row++) {
                    const values = [];
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        // 검증 컬럼 제외
                        if (col > 0) {
                            const cellAddress = XLSX.utils.encode_cell({r: row, c: col});
                            const cellValue = worksheet[cellAddress] ? worksheet[cellAddress].v : undefined;
                            values.push(cellValue);
                        }
                    }
                    ri_main.triggerAppendTableRow(values, {type: "upload"});
                }
            };
            reader.readAsBinaryString(file);
        },

        onClickFormInput : () => {
            const values = ri_main.getFormTableValues();
            if (ri_main.isEmptyValue(values)) {
                return;
            }
            ri_main.triggerAppendTableRow(values);         
        },

        onClickFormInit : () => {
            if (!confirm("입력된 내용을 모두 초기화 하시겠습니까?")) {
                return;
            }
            ri_main.clearForm();
        }
    }
};
</script>

</head>
<body>
    <div class="top-fixed no-wrap">
        <div>
            <a href="javascript:ri_main.eventHandler.onClickDownload();" class="button">다운로드</a>
            <input type="file" id="excelUpload" accept=".xlsx">
            <a href="javascript:ri_main.eventHandler.onClickUpload();" class="button">업로드</a>
        </div>        
        <div>
            <label for="separator">구분자:</label>
            <select id="separator">
                <option value=" " selected>(공백)</option>
                <option value=",">,</option>
                <option value="/">/</option>
            </select>
            <input type="text" id="separatorBox" class="input-form-box">&nbsp;<a href="javascript:ri_main.eventHandler.onClickInput();" class="button">간편입력</a><br>
            <label>검증결과: <input type="text" id="illegal" class="input-form-box illegal" disabled></label>
        </div>
        <div class="overflow">
            <table class="tbl-input">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <div>            
            <a href="javascript:ri_main.eventHandler.onClickFormInput();" class="button">입력</a>&nbsp;&nbsp;
            <a href="javascript:ri_main.eventHandler.onClickFormInit();" class="button">초기화</a>&nbsp;&nbsp;
            <label><input type="checkbox" id="autoInit">입력 후 자동 초기화</label>
        </div>
    </div>    
    <div class="content no-wrap">
        <!-- 입력 결과 출력 (삭제 기능) -->
        <table id="sheet1" class="tbl-result">
            <thead></thead>
            <tbody></tbody>        
        </table>
    </div>
    
    <div id="caution" class="floating-box hidden"></div>    
<script>
$(document).ready(() => {
    if ($.isEmptyObject(ri_rule)) {
        alert("입력 규칙 설정 후 사용 가능합니다.");
        $("#separatorBox, .input-box").attr("disabled", true);
        return;
    }    

    ri_main.initFormTableHead();
    ri_main.initFormTableBody();
    ri_main.initResultTable();
    ri_main.initCautionBox();

    ri_main.fixedForm();
});

$(window).resize(() => {
    ri_main.fixedForm();
});
</script>
</body>
</html>