<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">

<title>리서치 입력 프로그램</title>

<style>
.tbl_result {
    width: 100%;
    border-collapse: collapse;
}

.tbl_result th, .tbl_result td {
    border: 1px solid black;
}
</style>


<script src="https://code.jquery.com/jquery-3.7.0.slim.min.js" integrity="sha256-tG5mcZUtJsZvyKAxYLVXrmjKBVLd6VpVccqz/r4ypFE=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>


<script>
//----------------------- 입력 규칙 -----------------------//
const ri_rule = {
    head: ["id","1","2","3","3-1","3-2","4","5","6","7","8"],
    rule: [{},{},{},{}]
};
//----------------------- 입력 규칙 -----------------------//

const ri_main = {
    s2ab(s) { 
        // ref : https://redstapler.co/sheetjs-tutorial-create-xlsx/
        var buf = new ArrayBuffer(s.length); //convert s to arrayBuffer
        var view = new Uint8Array(buf);  //create uint8array as viewer
        for (var i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF; //convert to octet
        return buf;    
    },

    eventHandler : {
        onClickInput : function() {
            
            // 입력값 체크
            var newRow = $("<tr>");
            
            // 첫번째는 삭제 버튼
            newRow.append($("<td>").append($("<a>").addClass("delete-link").attr("href", "#").text("삭제")));

            var inputData = $("#result").val().split(",");
            for(var i = 0; i < ri_rule.head.length; i++) {
                if (i < inputData.length) {
                    newRow.append($("<td>").text(inputData[i]));
                } else {
                    newRow.append($("<td>").text(""));
                }
            }

            var lastRow = $("#sheet1 tbody tr:last");
            if (lastRow.length) {
                lastRow.after(newRow);
            } else {
                // 테이블에 행이 없는 경우, tbody 내부에 직접 추가합니다.
                $("#sheet1 tbody").append(newRow);
            }

            // 현재 행 삭제 이벤트 추가
            $(".delete-link").on("click", function(e) {        
                e.preventDefault();
                $(this).closest("tr").remove();
            });
        },
        onClickExcel : function() {
            
            var workbook = XLSX.utils.book_new();
            var worksheet = XLSX.utils.table_to_sheet(document.getElementById('sheet1'));

            // TODO: 삭제 버튼 컬럼 삭제, 모든 입력값 문자열로 취급

            XLSX.utils.book_append_sheet(workbook, worksheet, "sheet1");
            var workbookFile = XLSX.write(workbook, {bookType:'xlsx',  type: 'binary'});
            saveAs(new Blob([ri_main.s2ab(workbookFile)],{type:"application/octet-stream"}), "research_result.xlsx");
        }
    }
};
</script>

</head>
<body>
    <fieldset>
        <legend>리서치 입력</legend>
        입력 제한 규칙: <input type="text" id="rule" name="rule" disabled><br>
        <input type="text" id="result" name="result">&nbsp;<a href="javascript:ri_main.eventHandler.onClickInput();">입력</a><br>
        <input type="text" id="illegal" name="illegal" disabled>
    </fieldset>
    <div>
        <!-- 엑셀 출력 -->
        <a href="javascript:ri_main.eventHandler.onClickExcel();">Excel</a>

        <!-- 입력 결과 출력 (삭제 기능) -->
        <table id="sheet1" class="tbl_result">
            <thead></thead>
            <tbody></tbody>        
        </table>
    </div>
    
<script>
$(document).ready(function(){

    if ($.isEmptyObject(ri_rule)) {
        alert("입력 규칙 설정 후 사용 가능합니다.");
        $("#result, #put, #excel").attr("disabled", true);
        return;
    }

    var newRow = $("<tr>");
    newRow.append($("<th>").text("구분"));
    ri_rule.head.forEach(e => {
        newRow.append($("<th>").text(e));
    });
    $("#sheet1 thead").empty().append(newRow);
});
</script>
</body>
</html>